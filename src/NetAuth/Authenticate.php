<?php
namespace NetAuth; class Authenticate { private $ssoToken; public function __construct() { add_filter('authenticate', array($this, 'validate'), 10, 3); } public function validate($spf7500b, $spdc9d0a, $spec26ce) { if (empty($spdc9d0a) || empty($spec26ce)) { return false; } try { $spf7500b = get_user_by('login', $spdc9d0a); $sp4d422f = get_user_meta($spf7500b->ID, 'netforum', true); if (is_object($spf7500b) && empty($sp4d422f)) { return false; } $spe82dbb = $this->authenticate($spdc9d0a, $spec26ce); $sp2ba038 = array('user_email' => strtolower($spe82dbb->EmailAddress), 'user_login' => strtolower($spe82dbb->EmailAddress), 'first_name' => ucwords($spe82dbb->ind_first_name), 'last_name' => ucwords($spe82dbb->ind_last_name), 'nickname' => ucwords($spe82dbb->ind_first_name) . ' ' . ucwords($spe82dbb->ind_last_name), ''); if (!is_object($spf7500b)) { if ($spee87ba = $this->sp1f21ab($spe82dbb->cst_id, $spf7500b->ID)) { global $wpdb; $wpdb->update($wpdb->users, array_slice($sp2ba038, 0, 2), array('ID' => $spee87ba)); $spf7500b = new \WP_User(wp_update_user(array('ID' => $spee87ba) + $sp2ba038)); } else { $spf7500b = new \WP_User(wp_insert_user($sp2ba038)); } } else { wp_update_user($sp2ba038 + array('ID' => $spf7500b->ID)); } $this->setSession($spe82dbb, $spf7500b); do_action('nf_SyncGroups'); } catch (\Exception $sp89316e) { remove_action('authenticate', 'wp_authenticate_username_password', 20); $spf7500b = new \WP_Error('denied', __('Uh Oh!<br> ' . $sp89316e->getMessage())); } return $spf7500b; } protected function setSession($spe82dbb, $spf7500b) { $sp339e89 = array('cst_id' => (int) $spe82dbb->cst_id, 'cst_key' => (string) $spe82dbb->cst_key, 'sso_token' => $this->ssoToken); update_user_meta($spf7500b->ID, 'netforum', $sp339e89); if (!session_id()) { session_start(); } $_SESSION += array('netforum' => $spe82dbb); } protected function authenticate($spdc9d0a, $spec26ce) { $spf1298d = get_option('netforum'); if (!is_array($spf1298d) || empty($spf1298d['single_sign_on']['wsdl'])) { throw new \Exception('Something went wrong, netforum xweb credentials not set.'); } $sp4ef41f = array('debug' => false, 'ttl' => 12, 'timeout' => $spf1298d['connection']['timeout'], 'wsdl' => $spf1298d['single_sign_on']['wsdl'], 'username' => $spf1298d['single_sign_on']['username'], 'password' => $spf1298d['single_sign_on']['password'], 'credentials' => array('username' => $spdc9d0a, 'password' => $spec26ce)); if (class_exists('Netforum\\Views\\NetforumCache')) { $spf1298d = get_option('netforum_cache'); $sp4ef41f += array('cache' => array('path' => __DIR__ . '/tmp/', 'secret' => $spf1298d['cache']['key'], 'ttl' => $spf1298d['cache']['ttl'])); } $spe82dbb = new \Netforum\Providers\ServiceProvider($sp4ef41f); if (property_exists($spe82dbb, 'auth')) { $this->ssoToken = $spe82dbb->auth->getSsoToken(); return $spe82dbb->onDemand->getCustomerByKey(); } else { $this->ssoToken = $spe82dbb->simple->getSsoToken(); return $spe82dbb->simple->getCustomerByKey(); } } private function sp1f21ab($spdad2ea, $sp1558c9) { global $wpdb; if ($spdad2ea <= 0) { return false; } $sp1fc361 = $wpdb->get_row(sprintf('select * from %s where meta_value like "%s" limit 1', $wpdb->usermeta, '%\\"cst_id\\";i:' . (int) esc_sql($spdad2ea) . ';%')); if (!is_object($sp1fc361)) { return false; } return $sp1558c9 != $sp1fc361->user_id ? $sp1fc361->user_id : false; } }