<?php
namespace NetAuth; class Authenticate { private $ssoToken; public function __construct() { add_filter('authenticate', array($this, 'validate'), 10, 3); } public function validate($sp9b6b45, $speb1e17, $sp7d7d7a) { if (empty($speb1e17) || empty($sp7d7d7a)) { return false; } try { $sp9b6b45 = get_user_by('login', $speb1e17); $spf5b9b7 = get_user_meta($sp9b6b45->ID, 'netforum', true); if (is_object($sp9b6b45) && empty($spf5b9b7)) { return false; } $sp4a62f8 = $this->authenticate($speb1e17, $sp7d7d7a); $sp23164f = array('user_email' => strtolower($sp4a62f8->EmailAddress), 'user_login' => strtolower($sp4a62f8->EmailAddress), 'first_name' => ucwords($sp4a62f8->ind_first_name), 'last_name' => ucwords($sp4a62f8->ind_last_name), 'nickname' => ucwords($sp4a62f8->ind_first_name) . ' ' . ucwords($sp4a62f8->ind_last_name), ''); if (!is_object($sp9b6b45)) { if ($sp5314c0 = $this->sp9570ba($sp4a62f8->cst_id, $sp9b6b45->ID)) { global $wpdb; $wpdb->update($wpdb->users, array_slice($sp23164f, 0, 2), array('ID' => $sp5314c0)); $sp9b6b45 = new \WP_User(wp_update_user(array('ID' => $sp5314c0) + $sp23164f)); } else { $sp9b6b45 = new \WP_User(wp_insert_user($sp23164f)); } } else { wp_update_user($sp23164f + array('ID' => $sp9b6b45->ID)); } $this->setSession($sp4a62f8, $sp9b6b45); do_action('nf_SyncGroups'); } catch (\Exception $sp55c5a4) { remove_action('authenticate', 'wp_authenticate_username_password', 20); $sp9b6b45 = new \WP_Error('denied', __('Uh Oh!<br> ' . $sp55c5a4->getMessage())); } return $sp9b6b45; } protected function setSession($sp4a62f8, $sp9b6b45) { $sp315b9a = array('cst_id' => (int) $sp4a62f8->cst_id, 'cst_key' => (string) $sp4a62f8->cst_key, 'sso_token' => $this->ssoToken); update_user_meta($sp9b6b45->ID, 'netforum', $sp315b9a); if (!session_id()) { session_start(); } $_SESSION += array('netforum' => $sp4a62f8); } protected function authenticate($speb1e17, $sp7d7d7a) { $spb0bfa9 = get_option('netforum'); if (!is_array($spb0bfa9) || empty($spb0bfa9['single_sign_on']['wsdl'])) { throw new \Exception('Something went wrong, netforum xweb credentials not set.'); } $spc94edc = array('debug' => false, 'ttl' => 12, 'timeout' => $spb0bfa9['connection']['timeout'], 'wsdl' => $spb0bfa9['single_sign_on']['wsdl'], 'username' => $spb0bfa9['single_sign_on']['username'], 'password' => $spb0bfa9['single_sign_on']['password'], 'credentials' => array('username' => $speb1e17, 'password' => $sp7d7d7a)); if (class_exists('Netforum\\Views\\NetforumCache')) { $spb0bfa9 = get_option('netforum_cache'); $spc94edc += array('cache' => array('path' => __DIR__ . '/tmp/', 'secret' => $spb0bfa9['cache']['key'], 'ttl' => $spb0bfa9['cache']['ttl'])); } $sp4a62f8 = new \Netforum\Providers\ServiceProvider($spc94edc); if (property_exists($sp4a62f8, 'auth')) { $this->ssoToken = $sp4a62f8->auth->getSsoToken(); return $sp4a62f8->onDemand->getCustomerByKey(); } else { $this->ssoToken = $sp4a62f8->simple->getSsoToken(); return $sp4a62f8->simple->getCustomerByKey(); } } private function sp9570ba($sp8569f8, $spf17d89) { global $wpdb; if ($sp8569f8 <= 0) { return false; } $sp4f66fb = $wpdb->get_row(sprintf('select * from %s where meta_value like "%s" limit 1', $wpdb->usermeta, '%\\"cst_id\\";i:' . (int) esc_sql($sp8569f8) . ';%')); if (!is_object($sp4f66fb)) { return false; } return $spf17d89 != $sp4f66fb->user_id ? $sp4f66fb->user_id : false; } }